<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SIMG 해외여행자보험</title>
    <link rel="stylesheet" href="/css/bootstrap.css">
    <script src="/js/bootstrap.bundle.js"></script>
    <script src="/js/jquery-3.7.0.js"></script>
    <link rel="stylesheet" href="/css/simgoti.css">
    <script>
        let startDate = sessionStorage.getItem("startDate") || null;
        let startTime = sessionStorage.getItem("startTime") || null;
        let endDate = sessionStorage.getItem("endDate") || null;
        let endTime = sessionStorage.getItem("endTime") || null;
        let birth = sessionStorage.getItem("birth") || null;
        let gender = sessionStorage.getItem("gender") || null;
        let country;

        let startDt;
        let endDt;

        // 보험 나이 구하는 함수
        function calculateInsAge(birth){
            const yr = birth.substring(0,4);
            const mth = birth.substring(4,6);
            const dt = birth.substring(6,8);
            let today = new Date();
            today.setHours(0,0,0,0);
            const birthday = new Date(`${yr}-${mth}-${dt}`);
            const insAge = Math.round((today - birthday) / (365 * 24 * 60 * 60 * 1000));
            return insAge;
        }

        $(document).ready(function () {



            $("#start-date").val(startDate);
            $("#start-time-pick").val(startTime);
            $("#start-time").val(startTime);
            $("#end-date").val(endDate);
            $("#end-time-pick").val(endTime);
            $("#end-time").val(endTime);
            $("#birth").val(birth);
            $("#gender-pick").val(gender);
            $("#gender").val(gender=='M'?'남자':"여자");

            // 서버와 통신하여 country select 에 option 하나하나 넣기
            $.ajax({
                url: "/api/common/countryList",
                type: "GET",
                data: {},
                success: (data) => {
                    data.map(function (country) {
                        let target = "#others";
                        if (country.cntrFreq != 0) {
                            target = "#freq";
                        }
                        $(target).append("<option value='" + country.iso + "'>" + country.krNm + "</option>")
                    });

                },
                error: (err) => {
                    console.log(err)
                }
            });

            // 시간선택 select에 값 넣기
            for (let i = 0; i < 24; i++) {
                $(".time-pick").append("<option value='" + numPadding2(i) + ":00'>" + numPadding2(i) + ":00</option>")
            }

            // 나라 선택시 텍스트창에 넣고 변수 country에도 대입
            $("#country-select").on("change", function () {
                const selected = $("#country-select option:selected");
                $("#country-text").val(selected.text());
                country = selected.val();
            });

            // 출발일시, 종료일시 선택시 startDate, startTime, endDate, endTime에 값 넣기
            $("#start-date").on("change", function () {
                startDate = $(this).val();
            });
            $("#start-time-pick").on("change", function () {
                startTime = $(this).val();
            });
            $("#end-date").on("change", function () {
                endDate = $(this).val();
            });
            $("#end-time-pick").on("change", function () {
                endTime = $(this).val();
            });

            // 개인정보 입력시 값 저장
            $("#birth").on("keyup", function () {
                birth = $(this).val();
            });
            $("#gender-pick").on("change", function () {
                gender = $(this).val();
                // const selected = $("#gender-pick option:selected");
                // $("#gender").val(selected.text());
            });

            // 보험료 확인을 위한 변수
            let covTabs = {};
            let covDetails = {};

            // 보험료 확인버튼 클릭시
            $("#calculate-btn").on("click", function () {
                // 여행 일수 구하기
                const travelDay = Math.ceil((endDt - startDt) / (24 * 60 * 60 * 1000));

                $.ajax({
                    url: "/api/client/coverageList",
                    type: "GET",
                    data: {travelDay:travelDay},
                    success: (data) => {
                        // 요약칸 채우기
                        $(".summary").removeAttr("hidden");
                        $("#sum-period").text(travelDay+"일");
                        $("#sum-age").text(calculateInsAge(birth));
                        $("#sum-gender").text($("#gender").val());
                        $("#sum-country").text($("#country-text").val());

                        // calculate-result 보이게
                        $(".calculate-result").removeAttr("hidden");
                        covTabs = data.coverageTabList;
                        coverageList = data.coverageList;

                        covTabs.map(function(covTab){
                            covDetails[covTab.covCode] = {};
                        });

                        coverageList.map(function (covDetail) {
                            const covCode = covDetail.covCode;

                            covDetails[covCode][covDetail.covDCode] = ({
                                covDNm: covDetail.covDNm,
                                covDAmt: covDetail.covDAmt
                            })
                        });

                        $("#cov-tabs").empty();
                        $(".coverage-details").remove();

                        // 담보 종류에따라 탭 리스트 추가, 세부담보를 표시하기위한 div 추가
                        for(idx in covTabs) {
                            // 담보 선택 탭
                            $("#cov-tabs").append(
                                "<li class='col-4'>" +
                                "<button id='tab-"+covTabs[idx].covCode+"' class='w-100 cov-tab'>" +
                                "<div>"+covTabs[idx].covNm+"</div>" +
                                "<div>"+covTabs[idx].totPremium+"</div>" +
                                "</button>" +
                                "</li>"
                            )
                            // 세부담보 ul태그
                            $(".coverage-list").append(
                                "<div id='detail-"+covTabs[idx].covCode+"' class='coverage-details' hidden='hidden'>" +
                                "<ul id='list-"+covTabs[idx].covCode+"' class='list-unstyled text-start'></ul>" +
                                "</div>"
                            )
                            // "표준형"이 기본으로 표시되도록
                            $("#detail-10120102").removeAttr("hidden");
                        }

                        // 세부담보 div에 값 집어넣기
                        for(covKey in covDetails) {
                            for(covDKey in covDetails[covKey]){
                                const covDNm = covDetails[covKey][covDKey]["covDNm"];
                                const covDAmt = covDetails[covKey][covDKey]["covDAmt"];
                                $("#list-"+covKey).append(
                                    "<li class='row justify-content-between'>" +
                                    "<div class='col-9'><span>"+covDNm+"</span></div>" +
                                    "<div class='col-3 text-end'><span>"+covDAmt+"</span></div>"+
                                    "</li>"
                                );
                            }
                        }

                        moveScrollTop(".calculate-result");
                    },
                    error: (err) => {
                        console.log(err)
                    }
                });
            });

            // 문서의 모든 요소가 변할 때마다 동작
            $("html").on("change", function () {
                startDt = new Date(startDate + " " + startTime);
                endDt = new Date(endDate + " " + endTime);

                // 모두 입력했을때 로컬스토리지에 값 저장, 보험료확인 버튼 활성화,
                if (startDt != "Invalid Date" && endDt != "Invalid Date" && birth != "" && gender != null && country != null) {
                    sessionStorage.setItem("startDate",startDate);
                    sessionStorage.setItem("startTime", startTime);
                    sessionStorage.setItem("endDate", endDate);
                    sessionStorage.setItem("endTime", endTime);
                    sessionStorage.setItem("birth", birth);
                    sessionStorage.setItem("gender", gender);

                    $("#calculate-btn").removeAttr("disabled");
                } else {
                    $("#calculate-btn").attr("disabled", "disabled");
                }
            });

            // 담보 탭 클릭시
            $(document).on("click",".cov-tab",function(){
                const code = $(this).attr("id").split("-")[1];
                $(".coverage-details").attr("hidden","hidden");
                $("#detail-"+code).removeAttr("hidden");
                moveScrollTop(".calculate-result");
            });

            $("#apply-alone").on("click",function(){
                // location.href = "";
                const base = btoa(birth);
                const binary = atob(base);
                console.log(base);
                console.log(binary);
            });

        });


    </script>
</head>
<body>
<div class="mainView d-flex flex-column text-center">
    <div class="headerView">
        <h1>로고</h1>
        <h1>SIMG 해외여행자보험</h1>
    </div>
    <div class="contentsView">
        <!-- 상위 탭-->
        <ul class="list-unstyled row">
            <li class="col-3">
                <button id="calculateTab" class="w-100"><span>간편계산</span></button>
            </li>
            <li class="col-3">
                <button class="w-100"><span>보험가입</span></button>
            </li>
            <li class="col-3">
                <button class="w-100"><span>마이페이지</span></button>
            </li>
            <li class="col-3">
                <button class="w-100"><span>QnA</span></button>
            </li>
        </ul>
        <!-- 탭 아래 본문내용-->
        <div id="content">

            <!-- 여행 시작일-->
            <div class="text-start" id="travel-start">
                <span>여행 출발</span>
                <div class="row">
                    <div class="col-6">
                        <input type="date" class="form-control" id="start-date">
                    </div>
                    <div class="col-6 position-relative">
                        <input type="text" class="form-control time-input bg-white text-select" readonly
                               placeholder="시간"
                               name="start-time" id="start-time" value="">
                        <select id="start-time-pick"
                                class="form-control position-absolute top-100 text-option time-pick" hidden size="5"
                                style="z-index: 1">
                        </select>
                    </div>
                </div>
            </div>
            <!--  여행 종료일-->
            <div class="text-start" id="travel-end">
                <span>여행 종료</span>
                <div class="row">
                    <div class="col-6">
                        <input type="date" class="form-control" id="end-date">
                    </div>
                    <div class="col-6 position-relative">
                        <input type="text" class="form-control time-input bg-white text-select" readonly
                               placeholder="시간"
                               name="end-time" id="end-time" value="">
                        <select id="end-time-pick" class="form-control position-absolute top-100 text-option time-pick"
                                hidden size="5" style="z-index: 1">
                        </select>
                    </div>
                </div>
            </div>
            <!-- 나이 성별 -->
            <div class="text-start" id="birth-gender">
                <div class="row">
                    <div class="col-6">
                        <input type="text" class="form-control bg-white" id="birth" name="birth" placeholder="생년월일 8자리"
                               maxlength="8">
                    </div>
                    <div class="col-6 position-relative">
                        <input type="text" class="form-control bg-white text-select" readonly placeholder="성별"
                               id="gender">
                        <select name="gender-pick" id="gender-pick"
                                class="form-control position-absolute top-100 text-option" hidden size="2"
                                style="z-index: 1">
                            <!--                            <option value hidden selected>성별</option>-->
                            <option value="M">남자</option>
                            <option value="F">여자</option>
                        </select>
                    </div>
                </div>
            </div>
            <!-- 여행지 선택 -->
            <div class="text-start" id="country">
                <div class="row">
                    <div class="col-6">
                        <input type="text" placeholder="여행 국가 선택" id="country-text" readonly
                               class="show-popup form-control bg-white show-popup">
                        <div class="popup" hidden style="z-index: 1">
                            <div class="popup-content d-flex justify-content-center align-items-center">
                                <select name="country" id="country-select" class="form-select mb-4" size="17">
                                    <optgroup label="주요 여행국가" id="freq"></optgroup>
                                    <optgroup label="전체 국가" id="others"></optgroup>
                                </select>
                                <button type="button" class="btn main-btn close-popup">확인</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 d-flex align-items-end">
                        <button type="button" class="show-popup">여러 국가 여행시</button>
                        <div class="popup" hidden style="z-index: 2">
                            <div class="popup-content d-flex justify-content-center align-items-center">
                                <h3>여려 국가 여행시 국가 선택</h3>
                                <ol>
                                    <li>여러 국가 여행시 국가 선택은 첫번재 체류할 국가를 선택하시면 됩니다.</li>
                                    <li>여러국가를 여행하셔도 보험기간 동안은 모두 보장됩니다(단, 여행금지국가 등 3단계 이상의 여행경보지역 제외)</li>
                                    <li>여행지에 체코, 쿠바가 포함된 경우 여행국가를 체코, 쿠바로 선택해주세요</li>
                                    <li>가입증명서에 기재된 여행국가는 언제든지 마이페이지에서 변경 가능하며, 이 경우 변경된 국가가 반영된 가입증명서를 이메일로 다시 받으실 수
                                        있습니다
                                    </li>
                                </ol>
                                <button type="button" class="btn main-btn close-popup">확인</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 보험료 계산 버튼 -->
            <button type="button" class="btn main-btn" id="calculate-btn" disabled="disabled">보험료 확인</button>
            <!-- 입력정보 요약 -->
            <div class="summary" hidden="hidden">
                <table>
                    <tr>
                        <td><span>보험기간</span></td>
                        <td><span id="sum-period"></span></td>
                    </tr>
                    <tr>
                        <td><span>보험나이</span></td>
                        <td><span id="sum-age"></span></td>
                    </tr>
                    <tr>
                        <td><span>성별</span></td>
                        <td><span id="sum-gender"></span></td>
                    </tr>
                    <tr>
                        <td><span>여행국가</span></td>
                        <td><span id="sum-country"></span></td>
                    </tr>
                </table>
            </div>
            <!-- 보험료 계산결과/담보 리스트 -->
            <div class="calculate-result" hidden="hidden">
                <ul class="list-unstyled row" id="cov-tabs">

                </ul>
                <div class="coverage-list"></div>
                <!-- 가입신청 1인 동승자 버튼 -->
                <div class="row">
                    <div class="col-6">
                        <button type="button" class="btn main-btn col-6" id="apply-alone">1인 가입</button>
                    </div>
                    <div class="col-6">
                        <button type="button" class="btn main-btn col-6" id="apply-many">2인 이상 가입</button>
                    </div>
                </div>
            </div>

        </div>
    </div>


</div>
<div class="footer">
</div>
</body>
<script src="/js/commonjs.js"></script>
</html>